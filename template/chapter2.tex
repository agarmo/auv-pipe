\chapter{Modelling}

\section{Problem Formulation}
\label{chap2:problem}
	To solve the pipeline following problem it is important to have a clear and distinct problem formulation. 
	The case where the AUV is guided towards the pipeline is not so much of an interrest because it is a stright 
	forward problem which are the subject of many articles. 


	***WARNING, Usammenhengende*** b√∏ flyttes

	The following assumptions are needed to define the guidance problem:
		\begin{enumerate}
			\item The pipeline is layed on the sea bottom, which gives the pipeline the same
			height signature as the sea bottom. The guidance problem is then reduced to a
			two-dimentional problem.
			\item The pipeline is modelled as a point in space with a specific velocity which
			moves in the direction of the pipeline.
		\end{enumerate}

	The interresting case is when the AUV is to acquire the pipeline and track it by the means of a camera. The
	camera will output three points, distorted by noise. Since the AUV preferebly will travel with the
	pipeline, the coordinates of interrest will be the y-coordinates of the different points. It would be
	a good idea to formulate the points as points on the pipeline with a velocity moving with the AUV.

	This gives rise to formulate the pipeline as a point moving ahead of the AUV. The vessel will pursue
	this but it is convenient that it will never catch up with it.


\section{AUV model}
	The model used is the one from \cite{fossen}, and is written in the previous chapter, equation \eqref{eq:chp1-model}.
	
	\subsection{Assumptions}
	Assumtions that where made to simplify the modelling and implementation of the AUV system.
		\subsubsection{Low-speed assumption}
		The speed regieme of \textit{HUGIN 1000} is about 1-3 $m/s$. The design speed is around 2 $m/s$. 
		Then the assumtion about low-speed should be adequate.  

		This is a good idea to check. Run a simulation in simulink with the low speed model and the 
		nonlinear model and compare. Discuss later in the report, maybe.
		
		\subsubsection{Measurements}
		The vessel should have enough instrumentation available to measure $\eta$, $\nu$, and $\dot{\nu}$. 
		The distance to the sea bottom should also be available. All this instrumentation is common to 
		include in an standar AUV instrumentation package. 


\section{Camera modelling}
	The camera is modeled using a pinhole camera model. It assumes that the lense is an infintiesmall hole which 
	all light passes through. The image plane is located in the front of the projection plane at a distance $f$, 
	which is called the focus distance. This is not possible in real life, but simplyfies the mathematics a little. 
	This model is used to derive the interaction matrix, $\interaction$, which describes the movement of the 
	points in the image plane to the movement of the camera.\cite{robotbok} 

	The solution of equation \eqref{eq:ch1-image_point_veloc} gives the position of the points relative
	to the AUV. The x-axis of the camera coordinate system is defined along the pipeline, while the y-axis 
	is defined toward the left of the pipeline. This means that the points are moving out of the camera
	field-of-view after a short time, given non-zero \textit{surge}-velocity. Since the goal is to follow
	the pipeline and not a single point, it is convenient to formulate the pipeline as a point moving with
	the AUV with equal velocities. 

	


\section{Pipeline representation}
	The representation of the pipeline is important because it is used in the Kalman filter to predict
	where the pipeline is going. The pipeline is parametrized by $\varpi \in \mathbb{R}$ to get a
	continous and smooth pipeline.

	In this report the pipeline are parameterized as:
	\begin{equation}
		P_w(\varpi) = \left [ \begin{array}{c}
					\varpi \\
					k_y \varpi \\
					z(\eta)
				\end{array} \right ] \quad \varpi \in (0, \infty)
	\end{equation}
	where $k_y$ are constant and $z(\eta)$ is some function described by the sea bottom and are assumed
	known.
	
	


\section{Kalman filter}
	The Kalman filters purpose is to smooth the camera output and predict forward where the pipeline will
	be in the future to supply a better heading reference for the guidance controller.

	The position of the pipeline are given some uncertanty becuase the pipeline may have moved after it
	was layed or the position might be erronous. This gives:
	\begin{equation}
		P_w(\varpi) = \left [ \begin{array}{c}
					\varpi \\
					k_y \varpi \\
					z(\eta)
				\end{array} \right ] + \mathbf{B}\delta
	\end{equation}
	The function $\delta$ are a slowly varying disturbance which can be modeled as a \textit{1st order Markov
	Process}, and $\mathbf{B}$ is some 2x3 matrix.
	\begin{equation}
		\dot{\delta} = -\mathbf{T} \delta +  w
	\end{equation}
	where $w \in \mathbb{R}^2$, are a zero mean unity variance white noise process. This describes the
	error in the position. The matrix $\mathbf{T}$ specifies how the error evolves. Time differentianting
	the position estimate with regard to time gives
	\begin{equation}
		\dot{P_w}(\varpi) =  \left [ \begin{array}{c}
						\dot{\varpi} \\
						k_y \dot{\varpi} \\
						\dot{z}(\eta)
					\end{array} \right ] + \dot{\delta}
	\end{equation}
	By setting $\varpi = N(t)$, i.e the North position and completely disregarding the depth coordinate.
	gives the following
	\begin{equation}
		\dot{P_w'} = \left [ \begin{array}{c}
					n \\
					k_y n 
				\end{array} \right ] + \dot{\delta}
	\end{equation}
	Choseing the state vector and input as:
	\begin{equation}
		x = [ P_w'^T \quad \delta^T]^T \quad \Rightarrow  \quad \dot{x} = [\dot{P_w'^T} \quad
		\dot{\delta^T}]^T \quad  u = n
	\end{equation}
	This calls for the following state space representation 
	\begin{equation}
		\dot{x} = \left [ \begin{array}{cc}
					0 & -T \\
					0 & -T
				\end{array} \right] x + \left [ \begin{array}{c}
								1 \\
								k_y\\
								0 \\
								0
								\end{array} \right] u +
				\left [ \begin{array}{c}
						\mathbf{0}_{2x2} \\
						\mathbf{I}_{2x2} 
					\end{array} \right] w
	\end{equation}

	The measurement model are more complex. To be able to compare the measurement from the camera with the
	state space model, the perspective equations from Section \ref{ch1-cameramodel} are needed. By using
	Equations \eqref{eq:ch1-P_c} and \eqref{eq:ch1-perspective}, we can transform the point from World
	coordinates to image coordinates. We want $y = P_i$
	\begin{equation*}
		y = P_i = \mathbf{H} P_c = \mathbf{H R}^T ( P_w - \mathbf{O}(t))
	\end{equation*}
	$\mathbf{O}(t)$ is the origin of the camera frame and is equal to the position vector $\eta' = [N(t),
	E(t)]^T$. By including the position vector in the input to the filter and using 
	$P_w = \mathbf{C} x$, the measurement model are conclueded.
	\begin{equation}
		\label{eq:ch2-measurement}
		y = \mathbf{H R}^T \mathbf{C} x - \mathbf{H R}^T  \mathbf{O}(t)) = \mathbf{C}'x + \mathbf{D} u
	\end{equation}
	where $\mathbf{C'}$ and $\mathbf{D}$ are apropriate matrices for selecting the right states. $\mathbf{R}$
	are the Rotation Matrix from World coordinates to Camera coordinates. This gives the following model
	for the Kalman filter
	\begin{align}
		x &= \mathbf{A} x + \mathbf{B} u + \mathbf{E} w\\
		y &= \mathbf{C}'x + \mathbf{D} u + v\\
		\mathbf{A} &= \left [ \begin{matrix}
					0 & 0 & -T_1 & 0 \\
					0 & 0 & 0 & -T_2 \\
					0 & 0 & -T_1 & 0 \\
					0 & 0 & 0 & -T_2 
					\end{matrix} \right] \quad \mathbf{B} = \left[ \begin{matrix}
										1 & 0 & 0 \\
										k_y & 0 & 0\\
										0   & 0 & 0 \\
										0 & 0 & 0
										\end{matrix} \right]\\
		\mathbf{E} &= \left [ \begin{matrix}
					0 & 0 \\
					0 & 0 \\
					1 & 0 \\
					0 & 1
					\end{matrix} \right] \quad \mathbf{C}' = \left [ \begin{matrix}
						\frac{f}{z_c} \cos{\psi} &\frac{f}{z_c} \sin{\psi} & 0 & 0 \\
						-\frac{f}{z_c} \sin{\psi}& \frac{f}{z_c} \cos{\psi} & 0 & 0 
								\end{matrix} \right] \\
		\mathbf{D} &= \left [ \begin{matrix}
					0 & 0 & 0\\
					0 & -\frac{f}{z_c} \cos{\psi} & -\frac{f}{z_c} \sin{\psi} \\
					0 & \frac{f}{z_c} \sin{\psi} & -\frac{f}{z_c} \cos{\psi}
					\end{matrix} \right]
	\end{align}
	$w, v$ are a vectors of unity white noise and have covariance $E(ww^T) = \mathbf{Q}$ and $E(vv^T) =
	\mathbf{W}$




	
\section{Controller Design}
	The control system which supply the lower-level control system with forces and moments references, is 
	divided into 3 sub systems:
		\begin{itemize}
		 \item Speed control
		 \item Depth control
		 \item Heading control
		\end{itemize}
	This is called the flightmode controller, which is used for normal pipeline tracking, descent and ascent. 
	
	A fine-positioning controller is used to position the AUV on top of the pipeline and keep it there regadless 
	of ocean currents. This is to provide good pictures for the pipeline inspection mission.
	
	The \textit{HUGIN 1000} is a sleender-body type AUV. The coupling effects in in the surge and sway can be 
	neglected, and therfor decoupled. This means that one can create two subsystems from the AUV model: 
	The \textit{surge} subsystem, and the \textit{sway-yaw} subsystem. 
	
	TODO: Lage en figur som viser hvordan kontrollsystemet er bygget opp.
	
	TODO:Too keep the AUV right on top of the pipeline one can use kinematic control to with feedback from the 
	camera too keep the AUV right on top of the pipeline using theory from robot control by visual means.
	
	
	TODO:********Utledning og stabilitetsbevis for alle kontrollerene*******
	\subsection{Speed Controller}
		The speed controller is derived form the \textit{surge}-subsystem, called \textit{surge}-model
		\cite{fossen}. Under the slow speed assumption, the coriolis/centripetal-matrix is assumed
		zero, $\coriolis \approx 0$  
		\begin{equation}
			(m - X_{\dot{u}})\dot{u} - X_u u - X_{|u|u}|u| u = \tau_1
		\end{equation}
	
	
	
	\subsection{Depth Controller}
		To derive the depth controller in the crusing control system the
		\textit{longitudinal}-subsystem is used as the control model.

	
	\subsection{Heading Controller}
		Using the \textit{lateral}-subsystem representation from \cite{fossen}. Under the assumtions
		that $u, w, p, q, r, \phi,$ and $\theta$ from the longitudinal subsyustem are small, the
		kinematics are reduced to:
		\begin{align}
			\dot{\phi} &= p \\
			\dot{\psi} &= r 
		\end{align}
		The low-speed assumtion is utilized and higher order velocity terms are neglected, and
		constant \textit{surge}-velocity are assumed. This gives the following system:
		\begin{equation}
			\begin{aligned}
				\left [ \begin{array}{ccc}
					m - Y_{\dot{v}} & - m z_g - Y_{\dot{p}} & m x_g - Y_{\dot{r}} \\
					-m z_g - Y_{\dot{p}} & I_x - K_{\dot{p}} & I_{zx} - K_{\dot{r}} \\
					m x_g - Y_{\dot{r}} & I_{zg} - K_{\dot{r}} & I_z - N_{\dot{r}} 
					\end{array} \right]
				\left [ \begin{array}{c}
					\dot{v} \\
					\dot{p} \\
					\dot{r} 
					\end{array} \right] \\
				+ \left [ \begin{array}{ccc}
					-Y_v	&	-Y_p 	&	-Y_r \\
					-M_v	&	-M_p	&	-M_r \\
					-N_v	&	-N_P	&	-N_r
					\end{array} \right]
				\left [ \begin{array}{c}
					v \\
					p \\
					r 
				\end{array} \right] + 
				\left [ \begin{array}{ccc} 
					0 & 0 & (m - X_{\dot{u}})u \\
					0 & 0 &  0 \\
					(X_{\dot{u}} - Y_{\dot{v}}) u & 0 & m x_g u 
					\end{array} \right]	
				\left [ \begin{array}{c}
					v \\
					p \\
					r 
				\end{array} \right] \\
				+  \left [ \begin{array}{c}
					0 \\
					W z_b \sin \phi \\
					0 
					\end{array} \right] = \left [ \begin{array}{c}
									\tau_2 \\
									\tau_4 \\
									\tau_6
								      \end{array} \right ]
			\end{aligned}
		\end{equation}
		The \textit{roll}-state can be removed from the equations because of the assumtions of small
		$\dot{p}, p$. 


	
	\subsection{Over-Pipeline Tracking Controller}
		When the AUV is over the pipeline the need to keep the AUV on top of the pipeline to get deecent 
		pictures for the pipeline inspection, presents itself. To solve this problem a second controller 
		have been created just for this purpose. Since the vessel is controllable in 5 DOF the ability to 
		create a good controller for this purpose is good. 
		
		The controller uses input form the camera to get the position of the AUV relative to the pipeline 
		and give a suitable input to the controller.
		
\section{Guidance system}
	The guidAnce system on the \textit{HUGIN1000} AUV needs to be robust and tolerant to disturbances. The 
	vessel will be operating in the vicinity of ocean currents and other unpredictable factors which have to 
	be countered by the guidance system in a smart and robust way.
	
	
	
	\subsection{Line-of-Sight Guidance Law with Current Compensation}
		This is described in Section \ref{chap1-guidance-alg}. The LOS-angle is fed directly into the 
		heading controller as a reference. When ocean currents and disturbances are present, a modified 
		guidance law is presented. This uses the Side Slip angle, defined as:
		\begin{equation}
			\label{eq:chap2-sideslip}
			\beta = \sin^{-1} ( \frac{v}{\sqrt{u^2 + v^2 + w^2}})
		\end{equation}
		an alternative defenition of the side slip angle:
		\begin{equation*}
			\beta = \tan^{-1} (\frac{v}{u})
		\end{equation*}
		The new heading reference is then taken as
		\begin{equation}
			\label{eq:chap2-los-law}
			\psi_d = \psi_{LOS} - \beta
		\end{equation}
		Where $\psi_{LOS}$ is the LOS-angle from the current position to the next waypoint.
		
		The guidance law \eqref{eq:chap2-los-law} is used in the initial descent from the sea surface to the 
		starting position on the pipeline and final ascent to the surface, and other long-distance guidance.
		
	\subsection{Cross-Track Error Controller}
		The cross-track error is defined as the distance from the vessel to the Line-of-Sight line between 
		two waypoints. This controller seeks to minimize this error. The idea behind this controller is that 
		this should keep the AUV on top of the pipeline in the presence of current.
		
		TODO: Derive the Cross-track error guidance law. \cite{cross-track}
		
		
	
\section{Trajectory Generation}
	

	When the AUV does not find the pipeline exactly where it is, a certain search procedure are initiated.
	The AUV enters Search Mode and engages uses a maneuvering and tracking controller which follows a
	specified pattern inside a search corridor. The search corridor is specified by the user before the
	Pipeline inspeciton mission are initiated. 

	The AUV utilizes a tracking and maneuvering controller to follow the predetermined pattern. When the
	AUV picks up signs of where the pipeline is, the position is marked and a trajectory are created to
	turn the AUV in the right direction and give a good startpoint for the pipeline inspection procedure. 
	
	The goal states, which are the desired location for the AUV are filtered through a simplyfied
	reference model of the auv. This gives the desired trajectories for the vehicle to follow.

